{% extends 'base.html' %}
{% load static %}
{% block container %}

<div class="content">
    <div class="row">
        <div class="col-md-12">
            <div class="card-body">
                <div class="typography-line">
                    <h3 class="color-typography"><span>{{ descripcion }}</span></h3>
                </div>

                <div class="filter-controls-container">
                    <div class="date-filter-group">
                        <div class="calendar-button-wrapper">
                            <button class="calendar-button" id="dateRangeButton">
                                <span class="material-symbols-outlined me-2">
                                   ðŸ“…
                                </span>
                                <span id="dateRangeText">01/01/2025 - 31/12/2025</span>
                            </button>
                            <input type="text" id="datePicker" class="d-none">
                        </div>

                        <div class="predefined-buttons">
                            <button class="predefined-btn" data-range="M">M</button>
                            <button class="predefined-btn" data-range="3M">3M</button>
                            <button class="predefined-btn" data-range="6M">6M</button>
                            <button class="predefined-btn" data-range="A">A</button>
                            <button class="predefined-btn active" data-range="Max">MÃ¡x</button>
                        </div>
                    </div>
                </div>

                <div class="toolbar mt-4">
                    <button onclick="showView('chart')" class="active">ðŸ“ˆ</button>
                    <button onclick="showView('stats')">ðŸ“Š</button>
                </div>

                <div id="chartView" class="view active">
                    <div id="chart" style="height: 300px;"></div>
                </div>
                <div id="statsView" class="view">
                    <div id="chart-bar" style="height: 300px;"></div>
                </div>
                <div id="stats" class="text-muted display-4" style= "font-size: 18px"></div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.9/flatpickr.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.9/flatpickr.min.js"></script>
<script>
    var varId = "{{ var_id }}";
    var allData = [];

    // Inicializa Flatpickr
    const datePicker = flatpickr("#datePicker", {
        mode: "range",
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr) {
            if (selectedDates.length === 2) {
                const startDate = flatpickr.formatDate(selectedDates[0], "Y-m-d");
                const endDate = flatpickr.formatDate(selectedDates[1], "Y-m-d");

                document.getElementById('dateRangeText').textContent = `${flatpickr.formatDate(selectedDates[0], "d/m/Y")} - ${flatpickr.formatDate(selectedDates[1], "d/m/Y")}`;

                document.querySelectorAll('.predefined-btn').forEach(btn => btn.classList.remove('active'));

                applyFilter(startDate, endDate);
            }
        }
    });

    
    document.getElementById('dateRangeButton').addEventListener('click', function() {
        datePicker.open();
    });

    var line = new ApexCharts(document.querySelector("#chart"), {
        chart: {
            type: 'line',
            height: 550,
            toolbar: { show: true }
        },
        stroke: {
            curve: 'smooth',
            width: 3
        },
        markers: { size: 0 },
        colors: ['#007bff'],
        dataLabels: { enabled: false },
        series: [],
        xaxis: {
            categories: [],
            labels: { rotate: -45 }
        },
        noData: { text: "Cargando..." },
        grid: { borderColor: "#e0e0e0" }
    });
    line.render();

    var chart = new ApexCharts(document.querySelector("#chart-bar"), {
        chart: {
            type: 'bar',
            height: 550,
            toolbar: { show: true }
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        markers: { size: 0 },
        colors: ['#007bff'],
        dataLabels: { enabled: false },
        series: [],
        xaxis: {
            categories: [],
            labels: { rotate: -45 }
        },
        noData: { text: "Cargando..." },
        grid: { borderColor: "#e0e0e0" }
    });
    chart.render();

    function updateCharts(data, description) {
        if (!data || data.length === 0) {
            chart.updateSeries([{ name: description, data: [] }]);
            line.updateSeries([{ name: description, data: [] }]);
            document.getElementById("stats").innerHTML = "No hay datos para el rango de fechas seleccionado.";
            return;
        }

        var sorted = data.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
        var fechas = sorted.map(item => item.fecha);
        var valores = sorted.map(item => item.valor);

        chart.updateOptions({ xaxis: { categories: fechas } });
        chart.updateSeries([{ name: description, data: valores }]);

        line.updateOptions({ xaxis: { categories: fechas } });
        line.updateSeries([{ name: description, data: valores }]);

        let ultimo = valores[valores.length - 1];
        let promedio = (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2);
        let variacion = (((ultimo - valores[0]) / valores[0]) * 100).toFixed(2);

        document.getElementById("stats").innerHTML =
            `Ãšltimo dato: <b>${ultimo}</b> â€¢ Promedio: ${promedio} â€¢ VariaciÃ³n: ${variacion}%`;
    }

    function applyFilter(startDate, endDate) {
        if (!allData || allData.length === 0) {
            return;
        }

        const filteredData = allData.filter(item => {
            return item.fecha >= startDate && item.fecha <= endDate;
        });

        updateCharts(filteredData, "Datos Filtrados");
    }

    function loadData(id) {
        var url = `https://api.bcra.gob.ar/estadisticas/v3.0/monetarias/${id}`;

        $.getJSON(url, function(response) {
            allData = response.results;

            const today = new Date();
            const startOfYear = new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0];
            const endOfYear = new Date(today.getFullYear(), 11, 31).toISOString().split('T')[0];
            applyFilter(startOfYear, endOfYear);

            document.getElementById('dateRangeText').textContent = `01/06/${today.getFullYear()} - 31/12/${today.getFullYear()}`;
        }).fail(function() {
            console.error("Error al cargar los datos de la API.");
        });
    }

    document.querySelectorAll('.predefined-btn').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.predefined-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            const range = this.getAttribute('data-range');
            const today = new Date();
            let startDate, endDate = today.toISOString().split('T')[0];

            if (range === 'M') {
                today.setMonth(today.getMonth() - 1);
            } else if (range === '3M') {
                today.setMonth(today.getMonth() - 3);
            } else if (range === '6M') {
                today.setMonth(today.getMonth() - 6);
            } else if (range === 'A') {
                today.setFullYear(today.getFullYear() - 1);
            } else if (range === 'Max') {
                const firstDate = allData.length > 0 ? allData[0].fecha : '1900-01-01';
                startDate = firstDate;

                document.getElementById('dateRangeText').textContent = `MÃ¡ximo`;
                applyFilter(startDate, endDate);
                return;
            }

            startDate = today.toISOString().split('T')[0];
            document.getElementById('dateRangeText').textContent = `${flatpickr.formatDate(new Date(startDate), "d/m/Y")} - ${flatpickr.formatDate(new Date(endDate), "d/m/Y")}`;
            applyFilter(startDate, endDate);
        });
    });

    loadData(varId);
</script>
{% endblock container %}